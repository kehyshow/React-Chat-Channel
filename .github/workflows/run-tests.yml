name: Validate code

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  tests:
    name: Run builtin test cases
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Setup NodeJS 16.x
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: yarn
      - name: Run types validation
        shell: bash
        run: |
          yarn install --frozen-lockfile
          yarn run test
  e2e-tests:
    name: Run e2e tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          repository: pubnub/chat-components-e2e-tests
          ref: Playwright-setup-UI-1598
          token: ${{ secrets.GH_TOKEN }}
      - name: Install dependencies
        shell: bash
        run: |
          npm ci
          cd ${{ github.workspace }}/react/testing_apps/react-chat-components
          yarn install
          npx playwright install --with-deps
      - name: Clean up before tests
        shell: bash
        run: |
          RCC_PATH=${{ github.workspace }}/react/testing_apps/react-chat-components
          [[ -d "$RCC_PATH" ]] &&  rm -rf "$RCC_PATH"
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          path: react/testing_apps/react-chat-components
      - name: Setup NodeJS 16.x
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: yarn
      - name: Install dependencies
        shell: bash
        run: |
          npm ci
          cd ${{ github.workspace }}/react/testing_apps/react-chat-components
          yarn install
          npx playwright install --with-deps
      - name: Complete test applications setup
        shell: bash
        run: |
          cd ${{ github.workspace }}/react/testing_apps/react-chat-components/samples/react/group-chat
          yarn run setup
      - name: Run e2e tests
        shell: bash
        run: |
          cd ${{ github.workspace }}/react
          npx playwright test
      - name: Expose e2e test report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: ${{ github.workspace }}/react/playwright-report/*.html
          retention-days: 7
